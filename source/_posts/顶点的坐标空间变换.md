---
title: 顶点的坐标空间变换
tags: 笔记
categories:
  - 笔记
  - Unity
copyright: true
reward: true
date: 2020-02-19 19:57:34
thumbnail:
---


## 开始

> Unity Shader入门精要 4.6坐标空间

## Unity的空间概念

- **模型空间**模型空间

  也称为**对象空间**或**局部空间** 。**模型空间**会随着模型的**旋转**或**平移**而**旋转**或**平移** 。
  一个模型所包含的顶点坐标都是相对于模型空间的。

- **观察空间**

  也是摄像机空间。使用的是右手空间坐标系

- **裁剪空间**

  也叫**齐次裁剪空间**。用于对渲染图元进行裁剪。
  该空间的边界由**视锥体**定义，而视锥体决定了摄像机可以看到的空间。

- **屏幕空间**

  不同于其他空间，屏幕空间是一个二维空间

- **世界空间**
  
  是Unity坐标空间里最外层的坐标空间

## 顶点变换

顶点变换是一个如何让顶点从模型空间变换到屏幕空间的过程。

### 1. 模型变换

模型变换是指将模型的顶点坐标从**模型空间**转换到**世界空间**中的过程。

模型的变换矩阵可以根据模型的Transform组件的信息构建(这里的模型应该是在世界坐标系中的模型，而不是一个模型的子模型)。

用$k$表示缩放量，$θ$表示旋转量，$t$表示平移量，则一个缩放了$k$,绕y轴旋转了$Θ$，平移了$t$的模型，它的模型变换矩阵是:

$$
M_{modsl} =
\begin{bmatrix}
1 & 0 & 0 & t_x\\
0 & 1 & 0 & t_y\\
0 & 0 & 1 & t_z\\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
cosθ & 0 & sinθ & 0\\
0 & 1 & 0 & 0\\
-sinθ & 0 & cosθ & 0\\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
k_x & 0 & 0 & 0\\
0 & k_y & 0 & 0\\
0 & 0 & k_z & 0\\
0 & 0 & 0 & 1
\end{bmatrix}\\=
\begin{bmatrix}
k_xcosθ & 0 & k_zsinθ & t_x\\
0 & k_y & 0 & t_y\\
-k_xsinθ & 0 & k_zcosθ & t_z\\
0 & 0 & 0 & 1
\end{bmatrix}
$$

### 2. 观察变换

观察变换是指将顶点坐标从**世界空间**到**观察空间**的转换过程。

观察变换有两种思路(其实一样)：

1. 先用**模型变换**的方法得到**观察空间**到世界空间的变换矩阵，再对该矩阵求逆矩阵，得到观察变换矩阵。

2. 平移整个观察空间, 也就是构建一个可以让观察空间的原点、坐标轴和世界空间重合的变换矩阵(即模型变换矩阵的逆变换矩阵)，再对变换矩阵的z分量取反(由于观察空间用的是右手坐标系),得到观察变换矩阵

两种方式只是思考的方式不一样。但是因为第一种是要求逆矩阵的比较麻烦，而这个逆矩阵是可以直接从Transform组件信息间接得到的(也就是第二种方法)

### 3. 投影变换

**投影**是指顶点从**观察空间**到**裁剪空间**的过程。实现该过程的变换矩阵叫**裁剪矩阵**或**投影矩阵**。

投影有两个目的:

1. 为真正的投影(**投影到屏幕空间**)做准备，使顶点的齐次坐标的w分量有意义(*用于判断顶点是否在裁剪空间内*)。

2. 对x, y, z分量缩放，使w分量可以用来判断顶点是否在裁剪空间内。方式是:
若投影后得到的齐次坐标满足

   $$
   -w < x < w\\
   -w < y < w\\
   -w < z < w
   $$

则该顶点在裁剪空间内。

投影有两种类型:

1. **透视投影**

   透视投影的视锥体是一个长方体。其投影矩阵为:

   $$
   \begin{bmatrix}
   \frac{cot\frac{FOV}{2}}{Aspect} & 0 & 0 & 0\\
   0 & cot\frac{FOV}{2} & 0 & 0\\
   0 & 0 & -\frac{Far+Near}{Far-Near} & -\frac{2·Near·Far}{Far-Near}\\
   0 & 0 & -1 & 0
   \end{bmatrix}
  $$

2. **正交投影**

   正交投影的视锥体是一个金字塔型。其投影矩阵为:

   $$
   \begin{bmatrix}
   \frac{1}{Aspect} & 0 & 0 & 0\\
   0 & \frac{1}{Size} & 0 & 0\\
   0 & 0 & -\frac{2}{Far-Near} & -\frac{Far+Near}{Far-Near}\\
   0 & 0 & 0 & 1
   \end{bmatrix}
   $$

Aspect是摄像机的横纵比(Camera.aspect)，FOV即(Fied of View), Near,Far,Size参数都可以从Camera组件中得到。

### 4. 屏幕映射

将视锥体投影到屏幕空间的过程。由Unity控制。

1. **齐次除法**

   也叫透视除法。用齐次坐标的x,y,z分量分别除以w分量, 得到的坐标在OpenGL中叫**归一化的设备坐标**(**NDC**)。就是将四维空间转换到三维空间。

   经过齐次除法后，透视投影的裁剪空间会变成一个立方体。Unity使用的是OpenGL的方法，这个立方体的x, y, z 的分量范围在[-1,1]内(DirectX是[0,1])。

   对于正交投影,齐次除法不产生影响，即正交投影的NDC的值就是经过投影矩阵变换后的齐次坐标的值

2. **坐标映射到像素坐标**

   NDC的x,y分量将被映射到屏幕空间的像素坐标，z分量用作深度缓冲， w分量会在后续的工作中用到。

   齐次除法和屏幕映射国策可以用下面公式总结:

   $$
   screex_x = \frac{clip_x·pixelWidth}{2·clip_w}+\frac{pixelWidth}{2}\\
   screen_y = \frac{clip_y·pixelHeight}{2·clip_w} + \frac{pixelHeight}{2}
   $$
